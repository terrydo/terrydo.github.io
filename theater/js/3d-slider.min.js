"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(){var t=function t(e,i){if(_classCallCheck(this,t),!(this instanceof t))return new t(e,i);this._container=e,this._image_container,this._camera,this._scene,this._renderer,this._uniforms,this._material,this._configs={},this._textures=[],this._blank_texture,this._texture_map={},this._is_initted=!1,this._need_rendering=!1,this._is_animating=!1,this._current_texture_index=-1,this._next_texture_index=0,this._autoplay_interval,this._data={slide_progress:0,direction_sign:1},this._slides,this._pagination,this._default_configs={debug:!1,autoplay:!1,autoplayTimeout:7e3,duration:1500},this._init(i)};t.prototype._init=function(t){var e=this._default_configs,i=this._mergeOptions(e,t);this._configs=i,this._slides=this._container.querySelectorAll('[data-slide="slide"]'),this._loadTextures().then(function(){this._initTextures(),this._calcAllTexturesRatioFixingFactor(),this._initThreeScene(),this._initPaginations(),this._initAutoplay(),this._onWindowResize(),this._onWindowScrollWithInit(),window.addEventListener("resize",this._onWindowResize.bind(this),!1),window.addEventListener("scroll",this._onWindowScrollWithInit.bind(this),!1)}.bind(this))},t.prototype._loadTextures=function(){var i=this,e=[],n=[],r=this._texture_map;this._container.querySelectorAll('[data-slide="image_container"] img').forEach(function(t){n.push(t.currentSrc)});var s=new THREE.TextureLoader;return n.forEach(function(t,i){e[i]=new Promise(function(e){s.load(t,function(t){r[i]=t,e()})})}),e.push(new Promise(function(e){s.load("img/blank-image-layer.png",function(t){i._blank_texture=t,e()})})),Promise.all(e)},t.prototype._initTextures=function(){var t=[],e=this._texture_map;for(var i in e)t.push(e[i]);this._textures=t},t.prototype._initPaginations=function(){var n=this,r=this._container.querySelectorAll('[data-slide="pagination"]')[0],t=this._textures,s=[];t.forEach(function(t,e){var i=document.createElement("a");i.className="slider__pagination",i.href="#slide"+e,i.setAttribute("slide-id",e),i.addEventListener("click",function(){n._jumpSlide(e)}),r.appendChild(i),s.push(i)}),this._pagination=r,this._pagination_bullets=s},t.prototype._initAutoplay=function(){var t=this._configs;if(1==t.autoplay){var e=setInterval(function(){0!=this._need_rendering&&this._navigateSlide("next")}.bind(this),t.autoplayTimeout);this._autoplay_interval=e}},t.prototype._initThreeScene=function(){var t=this._container.querySelectorAll('[data-slide="image_container"]')[0],e=this._data,i=new THREE.Camera;i.position.z=1;var n=new THREE.Scene,r=new THREE.PlaneBufferGeometry(2,2),s={ratio_fixing_factor:{type:"v2",value:new THREE.Vector2},next_ratio_fixing_factor:{type:"v2",value:new THREE.Vector2},slide_progress:{type:"f",value:e.slide_progress},direction_sign:{type:"f",value:e.direction_sign},u_time:{type:"f",value:1},u_resolution:{type:"v2",value:new THREE.Vector2},u_mouse:{type:"v2",value:new THREE.Vector2},texture1:{type:"t",value:null},texture2:{type:"t",value:null}},o=new THREE.ShaderMaterial({uniforms:s,vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:document.getElementById("fragmentShader").textContent}),a=new THREE.Mesh(r,o);n.add(a);var _=new THREE.WebGLRenderer({precision:"highp",antialias:!1});t.appendChild(_.domElement),this._camera=i,this._scene=n,this._geometry=r,this._uniforms=s,this._material=o,this._mesh=a,this._renderer=_},t.prototype._getRatioFixingFactor=function(t){this._renderer;var e=window.innerWidth,i=window.innerHeight,n=t.image.width,r=t.image.height,s=i/r,o=n*s;return o<e?[1,o/e]:[o/e,1]},t.prototype._getCurrentTextureIndex=function(){return this._current_texture_index},t.prototype._getCurrentTexture=function(){return-1===this._current_texture_index?this._blank_texture:this._textures[this._current_texture_index]},t.prototype._getNextTexture=function(){return this._textures[this._next_texture_index]},t.prototype._getNextTextureIndex=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"next",e=this._getCurrentTextureIndex(),i=this._textures;return"next"==t?e==i.length-1?0:e+1:"prev"==t?0==e?i.length-1:e-1:"init"==t?0:void 0},t.prototype._getDirection=function(t){var e=this._current_texture_index;return-1===e?"init":e<t?"next":"prev"},t.prototype._updateTextures=function(){var t=this._uniforms,e=this._material,i=this._textures,n=this._current_texture_index,r=this._next_texture_index;t.texture1.value=-1===n?this._blank_texture:i[n],t.texture2.value=i[r],e.needsUpdate=!0},t.prototype._updatePagination=function(t){var e=this._pagination_bullets;e.forEach(function(t){return t.classList.remove("slider__pagination--active")}),e[t].classList.add("slider__pagination--active")},t.prototype._resetAutoplayInterval=function(){if(!0===this._configs.autoplay){var t=this._autoplay_interval;clearInterval(t),this._initAutoplay()}},t.prototype._navigateSlide=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"next",e=this._getNextTextureIndex(t);this._jumpSlide(e)},t.prototype._jumpSlide=function(t){var e=this;if(this._current_texture_index!=t){var i=this._data,n=this._container,r=this._is_animating,s=this._slides,o=(this._textures,this._getDirection(t)),a=this._configs;if(!0!==r){this._is_animating=!0,this._next_texture_index=t,this._updateTextures(),this._updatePagination(t),this._resetAutoplayInterval();var _=new TimelineMax({onComplete:function(){e._is_animating=!1,"init"==o&&n.classList.add("slider--initted"),e._current_texture_index=t,i.slide_progress=0,e._updateTextures()}});_.call(function(){s.forEach(function(t){return t.classList.remove("slider__item--active")}),i.direction_sign="prev"==o?-1:1}),_.fromTo(i,a.duration,{slide_progress:0},{slide_progress:1,ease:Power2.easeOut}),_.call(function(){s[t].classList.add("slider__item--active")},null,null,"-=0.2")}}},t.prototype._render=function(){if(!0===this._configs.debug&&console.log("Is rendering: "+this._need_rendering),!1!==this._need_rendering){var t=this._getCurrentTexture(),e=this._getNextTexture();this._uniforms.u_time.value+=.03,this._uniforms.slide_progress.value=this._data.slide_progress,this._uniforms.direction_sign.value=this._data.direction_sign,this._uniforms.ratio_fixing_factor.value.x=t.ratio_fixing_factor[0],this._uniforms.ratio_fixing_factor.value.y=t.ratio_fixing_factor[1],this._uniforms.next_ratio_fixing_factor.value.x=e.ratio_fixing_factor[0],this._uniforms.next_ratio_fixing_factor.value.y=e.ratio_fixing_factor[1],this._renderer.render(this._scene,this._camera)}},t.prototype._animate=function(){var t=this._need_rendering;!0===this._configs.debug&&console.log(t),requestAnimationFrame(function(){this._animate()}.bind(this)),this._render()},t.prototype._onWindowResize=function(t){this._uniforms;this._renderer.setSize(window.innerWidth,window.innerHeight),this._uniforms.u_resolution.value.x=this._renderer.domElement.width,this._uniforms.u_resolution.value.y=this._renderer.domElement.height,window.innerWidth<768?this._renderer.setPixelRatio(.7):this._renderer.setPixelRatio(window.devicePixelRatio),this._calcAllTexturesRatioFixingFactor()},t.prototype._onWindowScrollWithInit=function(){this._inview()?(this.is_initted()||this.init(),this.resume()):this.pause()},t.prototype._calcAllTexturesRatioFixingFactor=function(){var e=this;this._textures.forEach(function(t){t.ratio_fixing_factor=e._getRatioFixingFactor(t)}),this._blank_texture.ratio_fixing_factor=this._textures[0].ratio_fixing_factor},t.prototype._inview=function(){var t=window.innerHeight;return(document.documentElement.scrollTop||document.body.scrollTop)<t/1.5},t.prototype._mergeOptions=function(t,e){var i={};for(var n in t)i[n]=t[n];for(var r in e)i[r]=e[r];return i},t.prototype.pause=function(){this._need_rendering=!1},t.prototype.resume=function(){this._need_rendering=!0},t.prototype.init=function(){this._is_initted=!0,this._animate(),this._navigateSlide("init")},t.prototype.is_initted=function(){return this._is_initted},t.prototype.navigateSlide=function(t){this._navigateSlide(t)},window.Slider=t}();